/**
 * Access control for Angular applications
 * @version v0.0.1 - 2014-05-27
 * @link 
 * @author Kennth Lynne <kenneth.lynne@gmail.com>, Mohamed S.Zaghloul <m.salahz86@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */"use strict";angular.module("ngRoles",[]).provider("ngRoles",function(){var a=".";this.setSeparator=function(b){return a=b,this},this.$get=["$rootScope","$log",function(b,c){function d(a,b){this.name=a,this.roles=[],b&&b.length&&this.addRoles.apply(this,b)}function e(a,b){this.name=a,this.roles=[],this.applications=[],this.listeners={},b&&b.length&&this.addRoles.apply(this,b)}function f(a){return m.hasOwnProperty(a)?m[a]:null}function g(a){return n.hasOwnProperty(a)?n[a]:null}function h(a,b){var c=f(a);return null===c?m[a]=new d(a,b):b&&b.length&&m[a].addRoles.apply(m[a],b),self.hasOwnProperty(a)||(self[a]=m[a]),m[a]}function j(a,b){var c=g(a);return null===c?n[a]=new e(a,b):b&&b.length&&n[a].addRoles.apply(n[a],b),self.hasOwnProperty(a)||(self[a]=n[a]),n[a]}function k(){var a={},b={};for(var c in m)if(m.hasOwnProperty(c)){a[c]=[];for(var d=0;d<m[c].roles.length;d++)a[c].push(m[c].roles[d])}for(var e in n)if(n.hasOwnProperty(e)){b[e]=[];for(var d=0;d<n[e].roles.length;d++)b[e].push(n[e].roles[d])}return{applications:a,profiles:b}}function l(a){m={},n={};for(var b in a.applications)a.applications.hasOwnProperty(b)&&(m[b]=new d(b),m[b].addRoles.apply(m[b],a.applications[b]));for(var c in a.profiles)a.profiles.hasOwnProperty(c)&&(n[c]=new e(c),n[c].addRoles.apply(n[c],a.profiles[c]))}var m={},n={};return d.prototype.addRoles=function(){for(var a=0;a<arguments.length;a++)-1==this.roles.indexOf(arguments[a])&&(this.roles.push(arguments[a]),b.$emit(this.name+".role.add",arguments[a]));return this},d.prototype.removeRoles=function(){for(var a=0;a<arguments.length;a++)-1!=this.roles.indexOf(arguments[a])&&(this.roles.splice(this.roles.indexOf(arguments[a]),1),b.$emit(this.name+".role.del",arguments[a]));return this},e.prototype.addRoles=function(){for(var c=0;c<arguments.length;c++){var d=arguments[c];if(d.indexOf(a)<=0)throw new Error("A role must have an associated application");if(d=d.split(a,2),!m.hasOwnProperty(d[0]))throw new Error("Application not found");if("*"==d[1]){for(var e=0;e<m[d[0]].roles.length;e++)this.__addRole(d[0],m[d[0]].roles[e]);-1==this.applications.indexOf(d[0])&&(this.listeners[d[0]+".role.add"]=b.$on(d[0]+".role.add",this.__watchNewRoles(this,d[0])),this.listeners[d[0]+".role.del"]=b.$on(d[0]+".role.del",this.__watchRemoveRoles(this,d[0])),this.applications.push(d[0]))}else{if(-1==m[d[0]].roles.indexOf(d[1]))throw new Error("Application "+d[0]+" does not have "+d[1]+" role");this.__addRole(d[0],d[1])}}return this},e.prototype.removeRoles=function(){for(var b=0;b<arguments.length;b++){var c=arguments[b];if(c.indexOf(a)<=0)throw new Error("A role must have an associated application");if(c=c.split(a,2),!m.hasOwnProperty(c[0]))throw new Error("Application not found");if("*"==c[1]){for(var d=0;d<m[c[0]].roles.length;d++)this.__removeRole(c[0],m[c[0]].roles[d]);-1!=this.applications.indexOf(c[0])&&(this.listeners[c[0]+".role.add"](),this.listeners[c[0]+".role.del"](),this.applications.splice(this.applications.indexOf(c[0]),1))}else{if(-1==m[c[0]].roles.indexOf(c[1]))throw new Error("Application "+c[0]+" does not have "+c[1]+" role");this.__removeRole(c[0],c[1])}}return this},e.prototype.hasRoles=function(){for(var b=0;b<arguments.length;b++){var d=arguments[b];if(d.indexOf(a)<=0)return!1;if(d=d.split(a,2),!m.hasOwnProperty(d[0]))return!1;if("*"==d[1]){for(var e=0;e<m[d[0]].roles.length;e++)if(-1==this.roles.indexOf(d[0]+a+m[d[0]].roles[e]))return!1}else{if(-1==m[d[0]].roles.indexOf(d[1]))try{throw new Error("Application "+d[0]+" does not have "+d[1]+" role")}catch(f){c.error(f.message)}if(-1==this.roles.indexOf(d.join(a)))return!1}}return!0},e.prototype.hasAnyRoles=function(){for(var b=0;b<arguments.length;b++){var d=arguments[b];if(!(d.indexOf(a)<=0)&&(d=d.split(a,2),m.hasOwnProperty(d[0])))if("*"==d[1]){for(var e=0;e<m[d[0]].roles.length;e++)if(-1!=this.roles.indexOf(d[0]+a+m[d[0]].roles[e]))return!0}else{if(-1==m[d[0]].roles.indexOf(d[1]))try{throw new Error("Application "+d[0]+" does not have "+d[1]+" role")}catch(f){c.log(f.message)}if(-1!=this.roles.indexOf(d.join(a)))return!0}}return!1},e.prototype.__addRole=function(c,d){var e=c+a+d;-1==this.roles.indexOf(e)&&(this.roles.push(e),b.$emit(this.name+"profile.addrole",d))},e.prototype.__removeRole=function(c,d){var e=c+a+d;-1!=this.roles.indexOf(e)&&(this.roles.splice(this.roles.indexOf(e),1),b.$emit(this.name+"profile.delrole",arguments[i]))},e.prototype.__watchNewRoles=function(b,d){return function(e,f){var g=d+a+f;-1==b.roles.indexOf(g)&&(b.roles.push(g),c.log(g+" role added to "+b.name+" profile because it's own all "+d+" roles."))}},e.prototype.__watchRemoveRoles=function(b,d){return function(e,f){var g=d+a+f;-1!=b.roles.indexOf(g)&&(b.roles.splice(b.roles.indexOf(g),1),c.log(g+" role removed from "+b.name+" profile because it's own all "+d+" roles only."))}},{addApplication:h,addProfile:j,getApplication:f,getProfile:g,"import":l,"export":k}}]});